<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            width: 90%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            margin: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                width: 100%;
                padding: 15px;
                margin: 0;
                border-radius: 0;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #667eea;
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        
        .header p {
            color: #666;
            margin: 0;
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .header p {
                font-size: 13px;
            }
        }
        
        .api-setup {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .api-setup h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 18px;
        }
        
        .api-input-group {
            margin-bottom: 15px;
        }
        
        .api-input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        .api-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-section {
            margin-bottom: 25px;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-voice {
            background: #764ba2;
            color: white;
        }
        
        .btn-voice:hover {
            background: #653a8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }
        
        .btn-voice.listening {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .results-section {
            margin-top: 25px;
        }
        
        .results-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .book-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .book-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .book-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .book-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .book-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        .book-info-item {
            font-size: 14px;
            color: #666;
        }
        
        .book-info-item strong {
            color: #333;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
        }
        
        .stats-section h3 {
            color: #667eea;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-label {
                font-size: 13px;
            }
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 id="system-title">üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h1>
    <p id="welcome-message">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ AI</p>
   </div>
   <div class="api-setup">
    <h3 id="api-instruction">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px;"><span id="connection-status">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
    </div>
   </div>
   <div class="search-section">
    <div class="search-controls"><input type="text" class="search-input" id="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô AI, Python, ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û..."> <button class="btn btn-voice" id="voice-btn"> <span>üéôÔ∏è</span> <span id="voice-text">‡∏û‡∏π‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span> </button> <button class="btn btn-primary" id="search-btn"> <span>üîç</span> <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span> </button>
    </div>
    <div class="status-message" id="status-message"></div>
   </div>
   <div class="results-section" id="results-section" style="display: none;">
    <h2>üìö ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
    <div id="results-container"></div>
   </div>
   <div class="stats-section">
    <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
    <div class="stats-grid">
     <div class="stat-card">
      <div class="stat-value" id="total-searches">
       0
      </div>
      <div class="stat-label">
       ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-value" id="voice-searches">
       0
      </div>
      <div class="stat-label">
       ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-value" id="text-searches">
       0
      </div>
      <div class="stat-label">
       ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Google Sheets Configuration
        const SHEET_ID = '1FQfOrqiXUnvc55FfEm56yomQyqbd06mPf9HHSETgXfw';
        const SHEET_NAME = 'Books';
        const SHEET_RANGE = 'A2:E'; // Starting from row 2 to skip headers
        
        // Book database (will be loaded from Google Sheets)
        let booksDatabase = [
            // Sample data as fallback
            {
                title: "‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå",
                author: "‡∏î‡∏£.‡∏ß‡∏¥‡∏ó‡∏¢‡πå ‡∏Ñ‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç",
                category: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå",
                shelf: "‡∏ä‡∏±‡πâ‡∏ô 3",
                abstract: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå",
                keywords: ["AI", "‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå", "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ"]
            },
            {
                title: "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô",
                author: "‡∏≠.‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏™‡∏≠‡∏ô‡∏î‡∏µ",
                category: "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏°‡∏¥‡πà‡∏á",
                shelf: "‡∏ä‡∏±‡πâ‡∏ô 2",
                abstract: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
                keywords: ["Python", "Programming", "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°"]
            },
            {
                title: "‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",
                author: "‡∏î‡∏£.‡∏™‡∏°‡∏õ‡∏≠‡∏á ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πâ",
                category: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå",
                shelf: "‡∏ä‡∏±‡πâ‡∏ô 3",
                abstract: "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ Machine Learning ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ",
                keywords: ["Machine Learning", "ML", "AI"]
            },
            {
                title: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏¢‡∏Ñ‡∏∞",
                author: "‡∏≠.‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á",
                category: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
                shelf: "‡∏ä‡∏±‡πâ‡∏ô 1",
                abstract: "‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏¢‡∏Ñ‡∏∞",
                keywords: ["‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡πÇ‡∏¢‡∏Ñ‡∏∞", "‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢"]
            },
            {
                title: "Data Science ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
                author: "‡∏î‡∏£.‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                category: "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                shelf: "‡∏ä‡∏±‡πâ‡∏ô 3",
                abstract: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                keywords: ["Data Science", "Python", "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"]
            }
        ];

        // Load books from Google Sheets
        async function loadBooksFromSheets() {
            const connectionStatus = document.getElementById('connection-status');
            connectionStatus.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            try {
                // Use public access URL for Google Sheets
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length <= 1) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets');
                }
                
                // Parse data from sheets (skip header row)
                booksDatabase = rows.slice(1).map(row => {
                    const title = row[0] || '';
                    const author = row[1] || '';
                    const category = row[2] || '';
                    const shelf = row[3] || '';
                    const abstract = row[4] || '';
                    
                    // Generate keywords from all fields
                    const keywords = [
                        ...title.split(' '),
                        ...author.split(' '),
                        ...category.split(' '),
                        ...abstract.split(' ')
                    ].filter(word => word.length > 1);
                    
                    return {
                        title,
                        author,
                        category,
                        shelf,
                        abstract,
                        keywords
                    };
                }).filter(book => book.title); // Filter out empty rows
                
                connectionStatus.textContent = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${booksDatabase.length} ‡πÄ‡∏•‡πà‡∏°`;
                showStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${booksDatabase.length} ‡πÄ‡∏•‡πà‡∏°`, 'success');
                
                return true;
            } catch (error) {
                connectionStatus.textContent = `‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á`;
                showStatus(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ó‡∏ô`, 'error');
                return false;
            }
        }

        // Simple CSV parser
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField);
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentField || currentRow.length > 0) {
                        currentRow.push(currentField);
                        rows.push(currentRow);
                        currentRow = [];
                        currentField = '';
                    }
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentField += char;
                }
            }
            
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                rows.push(currentRow);
            }
            
            return rows;
        }

        // Configuration
        const defaultConfig = {
            system_title: "üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞",
            welcome_message: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ AI",
            api_instruction: "‚öôÔ∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
        };

        let isListening = false;
        let recognition = null;

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                updateStats(data);
            }
        };

        // Initialize SDKs
        async function initializeSdks() {
            const dataResult = await window.dataSdk.init(dataHandler);
            if (!dataResult.isOk) {
                console.error("Failed to initialize data SDK");
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
                        document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
                        document.getElementById('api-instruction').textContent = config.api_instruction || defaultConfig.api_instruction;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["system_title", config.system_title || defaultConfig.system_title],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                        ["api_instruction", config.api_instruction || defaultConfig.api_instruction]
                    ])
                });
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Voice search
        document.getElementById('voice-btn').addEventListener('click', () => {
            if (!recognition) {
                showStatus('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'error');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            isListening = true;
            document.getElementById('voice-btn').classList.add('listening');
            document.getElementById('voice-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', 'info');

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('search-input').value = transcript;
                showStatus(`‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á: "${transcript}"`, 'success');
                performSearch(transcript, 'voice');
            };

            recognition.onerror = (event) => {
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'error');
                resetVoiceButton();
            };

            recognition.onend = () => {
                resetVoiceButton();
            };
        });

        function resetVoiceButton() {
            isListening = false;
            document.getElementById('voice-btn').classList.remove('listening');
            document.getElementById('voice-text').textContent = '‡∏û‡∏π‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
        }

        // Text search
        document.getElementById('search-btn').addEventListener('click', () => {
            const query = document.getElementById('search-input').value.trim();
            if (query) {
                performSearch(query, 'text');
            } else {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            }
        });

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    performSearch(query, 'text');
                }
            }
        });

        // Perform search
        async function performSearch(query, method) {
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', 'info');
            
            // Search in sample database
            const results = searchBooks(query);
            
            // Display results
            displayResults(results, query);
            
            // Log search
            await logSearch(query, results.length, method);
            
            // Speak results
            speakResults(results, query);
        }

        // Search books
        function searchBooks(query) {
            const queryLower = query.toLowerCase();
            return booksDatabase.filter(book => {
                const titleMatch = book.title.toLowerCase().includes(queryLower);
                const authorMatch = book.author.toLowerCase().includes(queryLower);
                const categoryMatch = book.category.toLowerCase().includes(queryLower);
                const abstractMatch = book.abstract.toLowerCase().includes(queryLower);
                const keywordMatch = book.keywords.some(kw => 
                    kw.toLowerCase().includes(queryLower) || 
                    queryLower.includes(kw.toLowerCase())
                );
                
                return titleMatch || authorMatch || categoryMatch || abstractMatch || keywordMatch;
            });
        }

        // Display results
        function displayResults(results, query) {
            const resultsSection = document.getElementById('results-section');
            const resultsContainer = document.getElementById('results-container');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <p>üòî ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${query}"</p>
                        <p>‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô AI, Python, ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
                    </div>
                `;
                showStatus(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${query}"`, 'error');
                return;
            }
            
            results.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.innerHTML = `
                    <div class="book-title">${book.title}</div>
                    ${book.abstract ? `<p style="color: #666; margin: 10px 0; font-size: 14px;">${book.abstract}</p>` : ''}
                    <div class="book-info">
                        <div class="book-info-item"><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á:</strong> ${book.author}</div>
                        <div class="book-info-item"><strong>‡∏´‡∏°‡∏ß‡∏î:</strong> ${book.category}</div>
                        <div class="book-info-item"><strong>‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠:</strong> ${book.shelf}</div>
                    </div>
                `;
                resultsContainer.appendChild(bookCard);
            });
            
            showStatus(`‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${results.length} ‡πÄ‡∏•‡πà‡∏°`, 'success');
        }

        // Speak results
        function speakResults(results, query) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance();
                utterance.lang = 'th-TH';
                
                if (results.length === 0) {
                    utterance.text = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ${query}`;
                } else if (results.length === 1) {
                    utterance.text = `‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 1 ‡πÄ‡∏•‡πà‡∏° ‡∏Ñ‡∏∑‡∏≠ ${results[0].title} ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${results[0].shelf}`;
                } else {
                    utterance.text = `‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${results.length} ‡πÄ‡∏•‡πà‡∏° ‡πÄ‡∏•‡πà‡∏°‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠ ${results[0].title} ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${results[0].shelf}`;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // Log search
        async function logSearch(query, resultsCount, method) {
            const logEntry = {
                query: query,
                timestamp: new Date().toISOString(),
                results_count: resultsCount,
                search_method: method
            };
            
            const result = await window.dataSdk.create(logEntry);
            if (!result.isOk) {
                console.error("Failed to log search");
            }
        }

        // Update stats
        function updateStats(data) {
            const totalSearches = data.length;
            const voiceSearches = data.filter(log => log.search_method === 'voice').length;
            const textSearches = data.filter(log => log.search_method === 'text').length;
            
            document.getElementById('total-searches').textContent = totalSearches;
            document.getElementById('voice-searches').textContent = voiceSearches;
            document.getElementById('text-searches').textContent = textSearches;
        }

        // Initialize on load
        initializeSdks();
        
        // Auto-load books from Google Sheets on page load
        loadBooksFromSheets();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ab314d97a8895b',t:'MTc2MjUwMTMzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>