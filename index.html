<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            margin: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                width: 100%;
                padding: 15px;
                margin: 0;
                border-radius: 0;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            color: #667eea;
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        
        .header p {
            color: #666;
            margin: 0;
            font-size: 16px;
        }
        
        .admin-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: #764ba2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .admin-toggle:hover {
            background: #653a8a;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .admin-toggle {
                position: static;
                display: block;
                margin: 15px auto 0;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .header p {
                font-size: 13px;
            }
        }
        
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .login-modal.active {
            display: flex;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h2 {
            color: #667eea;
            margin: 0 0 20px 0;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .api-setup {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .api-setup h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 18px;
        }
        
        .search-section {
            margin-bottom: 25px;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-voice {
            background: #764ba2;
            color: white;
        }
        
        .btn-voice:hover {
            background: #653a8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }
        
        .btn-voice.listening {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .results-section {
            margin-top: 25px;
        }
        
        .results-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .book-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .book-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .book-call-number {
            font-size: 14px;
            color: #764ba2;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .book-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .book-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .book-info-item {
            font-size: 14px;
            color: #666;
        }
        
        .book-info-item strong {
            color: #333;
        }
        
        .book-availability {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .book-availability.available {
            background: #d4edda;
            color: #155724;
        }
        
        .book-availability.limited {
            background: #fff3cd;
            color: #856404;
        }
        
        .book-availability.unavailable {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .admin-section {
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .admin-header {
            background: #764ba2;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h2 {
            margin: 0;
        }
        
        .book-management {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .book-management h3 {
            color: #667eea;
            margin: 0 0 15px 0;
        }
        
        .book-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .admin-book-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .quantity-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .quantity-input {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            width: 80px;
            font-size: 14px;
        }
        
        .stats-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
        }
        
        .stats-section h3 {
            color: #667eea;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .stat-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        
        .stat-list li {
            padding: 8px;
            background: #f8f9ff;
            margin-bottom: 5px;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- User View -->
   <div id="user-view">
    <div class="header">
     <h1 id="system-title">üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h1>
     <p id="welcome-message">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ AI</p><button class="admin-toggle" id="admin-toggle">üë§ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    </div>
    <div class="api-setup">
     <h3>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
     <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px;"><span id="connection-status">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
     </div>
    </div>
    <div class="search-section">
     <div class="search-controls"><input type="text" class="search-input" id="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô AI, Python, ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û..."> <button class="btn btn-voice" id="voice-btn"> <span>üéôÔ∏è</span> <span id="voice-text">‡∏û‡∏π‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span> </button> <button class="btn btn-primary" id="search-btn"> <span>üîç</span> <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span> </button>
     </div>
     <div class="status-message" id="status-message"></div>
    </div>
    <div class="results-section" id="results-section" style="display: none;">
     <h2>üìö ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
     <div id="results-container"></div>
    </div>
    <div class="stats-section">
     <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-value" id="total-searches">
        0
       </div>
       <div class="stat-label">
        ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-label">
        ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
       </div>
       <ul class="stat-list" id="most-searched-books"></ul>
      </div>
      <div class="stat-card">
       <div class="stat-label">
        ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
       </div>
       <ul class="stat-list" id="most-searched-terms"></ul>
      </div>
     </div>
    </div>
   </div><!-- Admin View -->
   <div id="admin-view" class="admin-section">
    <div class="admin-header">
     <h2>üë®‚Äçüíº ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2><button class="btn btn-secondary" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
    <div class="book-management">
     <h3>üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
     <div class="book-list" id="admin-book-list"></div>
    </div>
    <div class="stats-section">
     <h3>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-label">
        ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
       </div>
       <ul class="stat-list" id="most-borrowed-books"></ul>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="total-books">
        0
       </div>
       <div class="stat-label">
        ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="total-borrowed">
        0
       </div>
       <div class="stat-label">
        ‡∏¢‡∏∑‡∏°‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Login Modal -->
  <div class="login-modal" id="login-modal">
   <div class="login-box">
    <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
    <form id="login-form">
     <div class="form-group"><label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="username" required>
     </div>
     <div class="form-group"><label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="password" required>
     </div>
     <div class="login-buttons"><button type="submit" class="btn btn-primary" style="flex: 1;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button> <button type="button" class="btn btn-secondary" id="cancel-login" style="flex: 1;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
     </div>
    </form>
   </div>
  </div>
  <script>
        // Google Sheets Configuration
        const SHEET_ID = '1FQfOrqiXUnvc55FfEm56yomQyqbd06mPf9HHSETgXfw';
        const SHEET_NAME = 'Books';
        
        // Book database
        let booksDatabase = [];
        let bookInventory = {};
        let allData = [];
        let isAdmin = false;
        
        // Configuration
        const defaultConfig = {
            system_title: "üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞",
            welcome_message: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ AI"
        };

        let isListening = false;
        let recognition = null;

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                allData = data;
                updateStats(data);
                if (isAdmin) {
                    updateAdminView(data);
                }
            }
        };

        // Initialize SDKs
        async function initializeSdks() {
            const dataResult = await window.dataSdk.init(dataHandler);
            if (!dataResult.isOk) {
                console.error("Failed to initialize data SDK");
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
                        document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["system_title", config.system_title || defaultConfig.system_title],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
                    ])
                });
            }
        }

        // Load books from Google Sheets
        async function loadBooksFromSheets() {
            const connectionStatus = document.getElementById('connection-status');
            connectionStatus.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length <= 1) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets');
                }
                
                // Parse data from sheets (skip header row)
                booksDatabase = rows.slice(1).map(row => {
                    const shelf = row[0] || '';
                    const title = row[1] || '';
                    const author = row[2] || '';
                    const category = row[3] || '';
                    const abstract = row[4] || '';
                    
                    const keywords = [
                        ...shelf.split(' '),
                        ...title.split(' '),
                        ...author.split(' '),
                        ...category.split(' '),
                        ...abstract.split(' ')
                    ].filter(word => word.length > 1);
                    
                    return {
                        shelf,
                        title,
                        author,
                        category,
                        abstract,
                        keywords
                    };
                }).filter(book => book.title);
                
                // Initialize inventory
                booksDatabase.forEach(book => {
                    if (!bookInventory[book.shelf]) {
                        bookInventory[book.shelf] = {
                            total: 0,
                            borrowed: 0,
                            available: 0
                        };
                    }
                });
                
                connectionStatus.textContent = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${booksDatabase.length} ‡πÄ‡∏•‡πà‡∏°`;
                showStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${booksDatabase.length} ‡πÄ‡∏•‡πà‡∏°`, 'success');
                
                return true;
            } catch (error) {
                connectionStatus.textContent = `‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`;
                showStatus(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets`, 'error');
                return false;
            }
        }

        // Simple CSV parser
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField);
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentField || currentRow.length > 0) {
                        currentRow.push(currentField);
                        rows.push(currentRow);
                        currentRow = [];
                        currentField = '';
                    }
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentField += char;
                }
            }
            
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                rows.push(currentRow);
            }
            
            return rows;
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Login functionality
        document.getElementById('admin-toggle').addEventListener('click', () => {
            document.getElementById('login-modal').classList.add('active');
        });

        document.getElementById('cancel-login').addEventListener('click', () => {
            document.getElementById('login-modal').classList.remove('active');
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'Admin' && password === '1234') {
                isAdmin = true;
                document.getElementById('login-modal').classList.remove('active');
                document.getElementById('user-view').style.display = 'none';
                document.getElementById('admin-view').classList.add('active');
                loadAdminData();
                showStatus('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                showStatus('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            isAdmin = false;
            document.getElementById('user-view').style.display = 'block';
            document.getElementById('admin-view').classList.remove('active');
            showStatus('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        });

        // Voice search
        document.getElementById('voice-btn').addEventListener('click', () => {
            if (!recognition) {
                showStatus('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'error');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            isListening = true;
            document.getElementById('voice-btn').classList.add('listening');
            document.getElementById('voice-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', 'info');

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('search-input').value = transcript;
                showStatus(`‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á: "${transcript}"`, 'success');
                performSearch(transcript, 'voice');
            };

            recognition.onerror = (event) => {
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'error');
                resetVoiceButton();
            };

            recognition.onend = () => {
                resetVoiceButton();
            };
        });

        function resetVoiceButton() {
            isListening = false;
            document.getElementById('voice-btn').classList.remove('listening');
            document.getElementById('voice-text').textContent = '‡∏û‡∏π‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
        }

        // Text search
        document.getElementById('search-btn').addEventListener('click', () => {
            const query = document.getElementById('search-input').value.trim();
            if (query) {
                performSearch(query, 'text');
            } else {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
            }
        });

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    performSearch(query, 'text');
                }
            }
        });

        // Perform search
        async function performSearch(query, method) {
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', 'info');
            
            const results = searchBooks(query);
            displayResults(results, query);
            await logSearch(query, results.length, method);
            speakResults(results, query);
        }

        // Search books
        function searchBooks(query) {
            const queryLower = query.toLowerCase();
            return booksDatabase.filter(book => {
                const shelfMatch = book.shelf.toLowerCase().includes(queryLower);
                const titleMatch = book.title.toLowerCase().includes(queryLower);
                const authorMatch = book.author.toLowerCase().includes(queryLower);
                const categoryMatch = book.category.toLowerCase().includes(queryLower);
                const abstractMatch = book.abstract.toLowerCase().includes(queryLower);
                const keywordMatch = book.keywords.some(kw => 
                    kw.toLowerCase().includes(queryLower) || 
                    queryLower.includes(kw.toLowerCase())
                );
                
                return shelfMatch || titleMatch || authorMatch || categoryMatch || abstractMatch || keywordMatch;
            });
        }

        // Display results
        function displayResults(results, query) {
            const resultsSection = document.getElementById('results-section');
            const resultsContainer = document.getElementById('results-container');
            
            resultsSection.style.display = 'block';
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <p>üòî ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${query}"</p>
                        <p>‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô</p>
                    </div>
                `;
                showStatus(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${query}"`, 'error');
                return;
            }
            
            results.forEach(book => {
                const inventory = bookInventory[book.shelf] || { total: 0, borrowed: 0, available: 0 };
                const available = inventory.available;
                
                let availabilityClass = 'unavailable';
                let availabilityText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°';
                
                if (available > 5) {
                    availabilityClass = 'available';
                    availabilityText = `‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° ${available} ‡πÄ‡∏•‡πà‡∏°`;
                } else if (available > 0) {
                    availabilityClass = 'limited';
                    availabilityText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${available} ‡πÄ‡∏•‡πà‡∏°`;
                }
                
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.innerHTML = `
                    <div class="book-call-number">‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: ${book.category}</div>
                    <div class="book-title">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: ${book.shelf}</div>
                    <div class="book-info">
                        <div class="book-info-item">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á:${book.title} </div>
                        <div class="book-info-item">‡∏´‡∏°‡∏ß‡∏î: ${book.author}</div>
                        ${book.abstract ? `<div class="book-info-item">‡∏ö‡∏ó‡∏Ñ‡∏±‡∏î‡∏¢‡πà‡∏≠: ${book.abstract}</div>` : ''}
                    </div>
                    <span class="book-availability ${availabilityClass}">${availabilityText}</span>
                `;
                resultsContainer.appendChild(bookCard);
            });
            
            showStatus(`‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${results.length} ‡πÄ‡∏•‡πà‡∏°`, 'success');
        }

        // Speak results
        function speakResults(results, query) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance();
                utterance.lang = 'th-TH';
                
                if (results.length === 0) {
                    utterance.text = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ${query}`;
                } else if (results.length === 1) {
                    const inventory = bookInventory[results[0].shelf] || { available: 0 };
                    utterance.text = `‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 1 ‡πÄ‡∏•‡πà‡∏° ‡∏Ñ‡∏∑‡∏≠ ${results[0].title} ‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏° ${inventory.available} ‡πÄ‡∏•‡πà‡∏°`;
                } else {
                    utterance.text = `‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ${results.length} ‡πÄ‡∏•‡πà‡∏°`;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // Log search
        async function logSearch(query, resultsCount, method) {
            const logEntry = {
                query: query,
                timestamp: new Date().toISOString(),
                results_count: resultsCount,
                search_method: method,
                type: 'search'
            };
            
            const result = await window.dataSdk.create(logEntry);
            if (!result.isOk) {
                console.error("Failed to log search");
            }
        }

        // Update stats
        function updateStats(data) {
            const searches = data.filter(d => d.type === 'search');
            document.getElementById('total-searches').textContent = searches.length;
            
            // Most searched terms
            const termCounts = {};
            searches.forEach(s => {
                termCounts[s.query] = (termCounts[s.query] || 0) + 1;
            });
            const topTerms = Object.entries(termCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const termsListEl = document.getElementById('most-searched-terms');
            termsListEl.innerHTML = topTerms.length > 0 
                ? topTerms.map(([term, count]) => `<li>${term} (${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</li>`).join('')
                : '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
            
            // Most searched books (based on search results)
            const bookSearchCounts = {};
            searches.forEach(s => {
                const results = searchBooks(s.query);
                results.forEach(book => {
                    bookSearchCounts[book.title] = (bookSearchCounts[book.title] || 0) + 1;
                });
            });
            const topBooks = Object.entries(bookSearchCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const booksListEl = document.getElementById('most-searched-books');
            booksListEl.innerHTML = topBooks.length > 0
                ? topBooks.map(([book, count]) => `<li>${book} (${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</li>`).join('')
                : '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
        }

        // Admin functions
        async function loadAdminData() {
            const adminBookList = document.getElementById('admin-book-list');
            adminBookList.innerHTML = '';
            
            booksDatabase.forEach(book => {
                const inventory = bookInventory[book.shelf];
                const card = document.createElement('div');
                card.className = 'admin-book-card';
                card.innerHTML = `
                    <div style="font-weight: 700; color: #667eea; margin-bottom: 8px;">${book.title}</div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: ${book.shelf}</div>
                    <div class="quantity-controls">
                        <input type="number" class="quantity-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value="${inventory.total}" id="total-${book.shelf}">
                        <input type="number" class="quantity-input" placeholder="‡∏¢‡∏∑‡∏°‡πÑ‡∏õ" value="${inventory.borrowed}" id="borrowed-${book.shelf}">
                        <button class="btn btn-success" onclick="updateInventory('${book.shelf}')">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #27ae60;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${inventory.available} ‡πÄ‡∏•‡πà‡∏°</div>
                `;
                adminBookList.appendChild(card);
            });
            
            updateAdminView(allData);
        }

        async function updateInventory(shelf) {
            const totalInput = document.getElementById(`total-${shelf}`);
            const borrowedInput = document.getElementById(`borrowed-${shelf}`);
            
            const total = parseInt(totalInput.value) || 0;
            const borrowed = parseInt(borrowedInput.value) || 0;
            const available = Math.max(0, total - borrowed);
            
            bookInventory[shelf] = { total, borrowed, available };
            
            const inventoryEntry = {
                type: 'inventory',
                book_id: shelf,
                total_quantity: total,
                borrowed_quantity: borrowed,
                available_quantity: available,
                timestamp: new Date().toISOString()
            };
            
            const result = await window.dataSdk.create(inventoryEntry);
            if (result.isOk) {
                showStatus('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                loadAdminData();
            } else {
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó', 'error');
            }
        }

        function updateAdminView(data) {
            const inventoryData = data.filter(d => d.type === 'inventory');
            
            // Update inventory from data
            inventoryData.forEach(inv => {
                if (inv.book_id) {
                    bookInventory[inv.book_id] = {
                        total: inv.total_quantity || 0,
                        borrowed: inv.borrowed_quantity || 0,
                        available: inv.available_quantity || 0
                    };
                }
            });
            
            // Calculate totals
            let totalBooks = 0;
            let totalBorrowed = 0;
            Object.values(bookInventory).forEach(inv => {
                totalBooks += inv.total;
                totalBorrowed += inv.borrowed;
            });
            
            document.getElementById('total-books').textContent = totalBooks;
            document.getElementById('total-borrowed').textContent = totalBorrowed;
            
            // Most borrowed books
            const borrowedCounts = Object.entries(bookInventory)
                .map(([shelf, inv]) => {
                    const book = booksDatabase.find(b => b.shelf === shelf);
                    return { title: book ? book.title : shelf, borrowed: inv.borrowed };
                })
                .filter(b => b.borrowed > 0)
                .sort((a, b) => b.borrowed - a.borrowed)
                .slice(0, 5);
            
            const borrowedListEl = document.getElementById('most-borrowed-books');
            borrowedListEl.innerHTML = borrowedCounts.length > 0
                ? borrowedCounts.map(b => `<li>${b.title} (${b.borrowed} ‡πÄ‡∏•‡πà‡∏°)</li>`).join('')
                : '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
        }

        // Make updateInventory global
        window.updateInventory = updateInventory;

        // Initialize on load
        initializeSdks();
        loadBooksFromSheets();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99abedc0f0d155a1',t:'MTc2MjUwOTA1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>